---
title: "Replication of Sleep Preferentially Enhances Memory for Emotional Components of Scenes by Payne, Stickgold, Swanberg and Kensinger (2008, Psychological Science)"
author: "Daniel Ogunbamowo (dogun@stanford.edu)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
---

<!-- Replication reports should all use this template to standardize reporting across projects.  These reports will be public supplementary materials that accompany the summary report(s) of the aggregate results. -->

## Introduction

*[No abstract is needed.]  Each replication project will have a straightforward, no frills report of the study and results.  These reports will be publicly available as supplementary material for the aggregate report(s) of the project as a whole.  Also, to maximize project integrity, the intro and methods will be written and critiqued in advance of data collection.  Introductions can be just 1-2 paragraphs clarifying the main idea of the original study, the target finding for replication, and any other essential information.  It will NOT have a literature review -- that is in the original publication. You can write both the introduction and the methods in past tense.*

*A short justification for your choice of experiment in terms of your research interests or research program (1 paragraph).*


**I am working with James Gross in the affective area, and the study of sleep and affect is a domain I am interested in. The lab just recently completed a large study on sleep bruxism and emotion regulation, and replicating this study will be a good way to prepare myself for exploring the lab’s data, and engaging with the relevant literature.**



*A description of the stimuli and procedures that will be required to conduct this experiment, and what the challenges will be (1-2 paragraphs).*


**Stimuli for this study include images containing a combination of a negative emotionally arousing object (a car crash), with a neutral background scene (a street), or a neutral object (a car) with a neutral background. Participants will be put into two groups. One group will view the set of images in the morning and the other group will view the images in the evening. Both groups will wait 12 hours (the morning group are not allowed to nap during the day), and will then be tested on how much they remember from the scenes they viewed earlier. During the test, they will be shown images that are either identical to the images they viewed earlier, images with similar object and background emotion valence to one they viewed earlier, or a new object. Participants will say whether they thought the image was identical, similar or new, for each image they are presented with during the test. The idea behind this study is to see whether emotionally arousing stimuli are better remembered than neutral stimuli after a night of sleep.**


**I think it might be difficult to get enough participants for this study. This was something Jinxiao, the student who ran the original replication, struggled with. I imagine I would have to start collecting data relatively earlier in the quarter to get a larger sample.**


**Secondly, this is not a a study that a participant can do in one 30 minute sitting. This will require them to participate at times both before and after sleep, and with 12 hour-long intervals between survey completions. Because participants won’t be in a lab, we won’t be able to monitor whether they  actually follow the study guidelines which may have a large impact on the resulting effect size.**




*A link to the repository and to the original paper (as hosted in your repo). The goal is that we should be able to click on these links and review that your repo is formatted right and look at the original paper.*


**Rescue Repository:** **https://github.com/dogunbamowo/payne2008_rescue**\
**Original Replication Repository:** **https://github.com/psych251/payne2008**\
**Original Paper (as hosted in my repo):** **https://github.com/dogunbamowo/payne2008_rescue/blob/main/original_paper/payne-et-al-2008-sleep-preferentially-enhances-memory-for-emotional-components-of-scenes.pdf**




## Summary of prior replication attempt

Based on the prior write-up, describe any differences between the original and 1st replication in terms of methods, sample, sample size, and analysis. Note any potential problems such as exclusion rates, noisy data, or issues with analysis. 

## Methods

### Power Analysis

Original effect size, power analysis for samples to achieve 80%, 90%, 95% power to detect that effect size.  Considerations of feasibility for selecting planned sample size.

How much power does your planned sample have for original effect? For an attenuated effect that is half the size of the original? 

(If power analysis is not possible or precise, discuss more fully how you determined a sample size that would be sufficient for rescue.)

### Planned Sample

Planned sample size and/or termination rule, sampling frame, known demographics if any, preselection rules if any.

### Materials

All materials - can quote directly from original article - just put the text in quotations and note that this was followed precisely.  Or, quote directly and just point out exceptions to what was described in the original article.

### Procedure	

Can quote directly from original article - just put the text in quotations and note that this was followed precisely.  Or, quote directly and just point out exceptions to what was described in the original article.

### Controls

What attention checks, positive or negative controls, or other quality control measures are you adding so that a (positive or negative) result will be more interpretable?


### Analysis Plan

Can also quote directly, though it is less often spelled out effectively for an analysis strategy section.  The key is to report an analysis strategy that is as close to the original - data cleaning rules, data exclusion rules, covariates, etc. - as possible.  

**Clarify key analysis of interest here**  You can also pre-specify additional analyses you plan to do.

### Differences from Original Study and 1st replication

Explicitly describe known differences in sample, setting, procedure, and analysis plan from original study.  The goal, of course, is to minimize those differences, but differences will inevitably occur.  Also, note whether such differences are anticipated to make a difference based on claims in the original article or subsequent published research on the conditions for obtaining the effect.

### Methods Addendum (Post Data Collection)

You can comment this section out prior to final report with data collection.

#### Actual Sample
  Sample size, demographics, data exclusions based on rules spelled out in analysis plan

#### Differences from pre-data collection methods plan
  Any differences from what was described as the original plan, or “none”.


## Results


### Data preparation

Data preparation following the analysis plan.

```{r include = F}
###Data Preparation
# dowload from Qualtrics

####Load Relevant Libraries and Functions
library(qualtRics)
library(tidyverse)
library(ggplot2)
library(cowplot)
library(stringr)
library(lubridate)# date and time
library(ez) # for repeated-measure ANOVA
library(lme4)
library(lmerTest) #optional: show p-value in lmer summary
library(scales) # print percentage
library(knitr)

```

```{r }
####Import data #all data should be exported from qualtrics as "choice text", not numerical
#session 1 data 
data_s1 <- readSurvey("~/Downloads/PSYCH251 Session 1 - Time Restrictions Removed_November 5, 2023_16.06.csv")
#wake group data
data_s2_wake <- readSurvey("~/Downloads/PSYCH251 Session 2_wake - Time Restrictions Removed_November 5, 2023_16.06.csv") %>% 
  mutate(condition = "wake")
#sleep group data
data_s2_sleep <- readSurvey("~/Downloads/PSYCH 251 Session 2_sleep Time Restrictions Removed_November 5, 2023_16.07.csv") %>% 
  mutate(condition = "sleep")

#combine the two raw datasets
data_s2 <- rbind(data_s2_wake,data_s2_sleep)

#### Data exclusion / filtering
# clean s1 data
data_s1_clean <- data_s1 %>% 
  select(-contains("Q34"), -contains("Q35"), -contains("Q19"), -contains("Q24"), -contains("prac")) #%>% 
  #filter(!is.na(am_or_pm))  

# final data collection started on 2018/12/12
#data_s1_clean <- data_s1_clean[mdy_hm(data_s1_clean$StartDate) >= ymd("2018-12-12"),]

# mark S1 variable names
names(data_s1_clean) <- str_c("s1_", names(data_s1_clean))

# clean s2 data
data_s2_clean <- data_s2 %>% 
  select(-contains("Q34"), -contains("Q35"), -contains("Q31"), -contains("Q42"), -contains("Q43"), -starts_with("Recipient"), -contains("s2p")) %>% 
  filter(!is.na("sleep_log#4_1"), 
         code_s1 != "999999", code_s1 != "99999", code_s1 != "888888")

```

```{r}

# final data collection started on 2018/12/12
#data_s2_clean <- data_s2_clean[mdy_hm(data_s2_clean$StartDate) >= ymd("2018-12-12"),]

# categorize participants into sleep-condition and wake-condition
#data_s2_clean <- data_s2_clean %>% 
  #mutate(time = mdy_hm(StartDate), condition = ifelse(hour(time) >= 5 & hour(time) <= 12, "sleep", "wake")) # considering time difference, the sleep group (across the US) starts Session 2 between 5 am and 12 pm 

# join s1 and s2 data
data_s1s2 <- left_join(data_s2_clean, data_s1_clean, by = c("code_s1" = "s1_code"))

# calculate the s1-s2 time gap
data_s1s2 = data_s1s2 %>% 
  mutate(int = interval(start = s1_StartDate, end =  StartDate)) %>% 
  mutate(time_gap_seconds = int_length(int)) %>% 
  mutate(time_gap_minutes = minute(seconds_to_period(time_gap_seconds))) %>%
  mutate(time_gap_hours = hour(seconds_to_period(time_gap_seconds))) %>% 
  select(-(int)) 

#data_s1s2 <- data_s1s2 %>% 
  #mutate(time_gap = as.numeric(mdy_hm(StartDate) - mdy_hm(s1_StartDate), units = "hours") ) # time gap in hours

# filter out participants who did not have S1 and S2 about 12 hours apart
#data_s1s2 <- data_s1s2 %>% 
  #filter(time_gap >10 & time_gap  < 14)
# check the condition assignment (is it consistent with reported am_or_pm during Session 1)


table(data_s1s2$condition, data_s1s2$s1_am_or_pm)

# distribution of S2 time of the day
ggplot(data_s1s2, aes(x = hour(StartDate), fill = condition))+
  geom_histogram(color = 'black') +
  labs(title = "Distribution of the time of Session 2 (in Pacific Time)", x = "Time of the day (hour)")+
  xlim(0, 24) + scale_y_continuous(breaks=seq(0, 10, 1))

# distribution of the time gap between S1 and S2
ggplot(data_s1s2, aes(x = time_gap_hours))+
  geom_histogram(color = 'black', fill = 'white') +
  labs(title = "Distribution of time gap between Session 1 and Session 2", x = "duration (hours)")+
  xlim(-1, 14)
```

```{r}
#### Prepare data for analysis - create columns etc.
# temp1: data with Q1 gathered (Q1: did you see this object/background?)
data <- data_s1s2 %>% 
  gather(item, s2_q1, contains("s2_q1")) %>% 
  mutate(item = substr(item, 1, str_length(item)-3))

# create item_number and rearrange the dataframe
data <- data %>% 
  mutate(item_number = as.numeric(str_sub(item, 1, str_length(item)-3))) %>%
  arrange(code_s1, item_number)


# read the stimuli list
item_list <- read_csv('~/Downloads/questions_list.csv')
# merge the item list to the data frame
data_joined <-  left_join(data, item_list, by = "item_number") 
# rearrange
data_joined <- data_joined %>% arrange(code_s1, item_number) 

## summarize into individual-wise data
data_ind <- data_joined %>% 
  # filter(type == "same") %>%  #only "same" trials were processed, one participant has 64 trials
  group_by(code_s1, condition, type, component, valence, s2_q1) %>% 
  mutate(count_ans = n()) #the number of all answers separately (same, similar, new)
data_ind <- data_ind %>% 
  # filter(type == "same") %>% 
  group_by(code_s1, condition, type, component, valence) %>% 
  mutate(count_all = n()) #the number of questions
# collapse to individual level
data_ind <- data_ind %>% 
  group_by(code_s1, condition, type, component, valence, s2_q1) %>% 
  summarise(count_ans = mean(count_ans, na.rm = T),
            count_all = mean(count_all, na.rm = T)) %>% 
  #filter(!is.na(s2_q1)) %>% #s2_q1 has to have a value
  spread(s2_q1, count_ans) #spread s2_q1

#replace na with 0
data_ind[is.na(data_ind)] <-  0 
#calculate specific and general recognition rate
data_ind <-  data_ind %>% 
  mutate(specific_recog = Identical/count_all, #specific recognition
         general_recog = Similar/(count_all-Identical) #general recognition
         ) 

# order the level of condition
data_ind$condition <- factor(data_ind$condition, levels=c('wake', 'sleep'), ordered=TRUE)
data_ind$component <- factor(data_ind$component, levels=c('object', 'background'), ordered=TRUE)

# show the head of the individual-wise data
kable(head(data_ind, 11), digit = 2)
```

###Confirmatory analysis
```{r}
## 3-way anova: test on the 3-way interaction
anova_3way = ezANOVA(
    data = data_ind %>% filter(type == "same"),
    dv = .(general_recog),
    wid = .(code_s1), 
    within = .(component, valence),
    between = .(condition)
)
#Show the ANOVA & assumption tests.
print(anova_3way)
```

```{r}
## 2-way anova: test on the key 2-way interaction on object recognition
anova_2way_obj = ezANOVA(
    data = data_ind %>% filter(type == "same", component == "object"),
    dv = .(general_recog),
    wid = .(code_s1), 
    within = .(valence),
    between = .(condition)
)
print(anova_2way_obj)
```

```{r}
## 2-way anova: test on the 2-way interaction on background
anova_2way_bgd = ezANOVA(
    data = data_ind %>% filter(type == "same", component == "background"),
    dv = .(general_recog),
    wid = .(code_s1), 
    within = .(valence),
    between = .(condition)
)
print(anova_2way_bgd)
```

###Data plots

```{r}
# summarize data for plotting
data_summary <- data_ind %>% 
  filter(type == "same") %>% 
  group_by(condition, component,valence) %>% 
  summarise(mean_spe_recog = mean(specific_recog, na.rm = T), 
            sd_spe_recog = sd(specific_recog, na.rm = TRUE), 
            se_spe_recog = sd_spe_recog/sqrt(n()), 
            ci_spe_recog =  1.96*se_spe_recog,# qt(0.975,df=length(specific_recog)-1)
            mean_gen_recog = mean(general_recog, na.rm = T), 
            sd_gen_recog = sd(general_recog, na.rm = TRUE), 
            se_gen_recog = sd_gen_recog/sqrt(n()), 
            ci_gen_recog =  1.96*se_gen_recog, # qt(0.975,df=length(general_recog)-1)
            # mean_all_recog = mean(all_recog, na.rm = T), 
            # sd_all_recog = sd(all_recog, na.rm = TRUE), 
            # se_all_recog = sd_all_recog/sqrt(n()), 
            # ci_all_recog =  1.96*se_all_recog, # qt(0.975,df=length(general_recog)-1)
            count = n())
# order the level of condition
# data_summary$condition <- factor(data_summary$condition, levels=c('wake', 'sleep'), ordered=TRUE)
# data_summary$component <- factor(data_summary$component, levels=c('object', 'background'), ordered=TRUE)

kable(head(data_summary, 8), digits = 2)
```

The results of general recognition of the two groups (wake and sleep) is in the subplot A blow.
```{r }
# plot general recognition
p1 <- ggplot(data_summary , aes(x = condition, y = mean_gen_recog, fill = component))+
  geom_bar(color = "black", stat = "identity", position=position_dodge(), width=0.5) + 
  geom_errorbar(aes(ymin=mean_gen_recog - ci_gen_recog, ymax=mean_gen_recog + ci_gen_recog), position=position_dodge(.5), width=.2, size=1) +
  #geom_point(data = data_ind, aes(x = condition, y = general_recog, fill = component), position=position_dodge(.5), color = "darkred", alpha = .5)+
  facet_grid(. ~ valence)+
  labs(title = "General recognition")+
  scale_fill_grey()+ ggthemes::theme_few()

# plot specific recognition
p2 <- ggplot(data_summary , aes(x = condition, y = mean_spe_recog, fill = component))+
  geom_bar(color = "black", stat = "identity", position=position_dodge(), width=0.5) + 
  geom_errorbar(aes(ymin=mean_spe_recog - ci_spe_recog, ymax=mean_spe_recog + ci_spe_recog), position=position_dodge(.5), width=.2, size=1) +
  #geom_point(data = data_ind, aes(x = condition, y = general_recog, fill = component), position=position_dodge(.5), color = "darkred", alpha = .5)+
  facet_grid(. ~ valence)+
  labs(title = "Specific recognition")+
  scale_fill_grey()+ ggthemes::theme_few()

plot_grid(p1, p2, ncol = 1, labels = c('A', 'B'))
```

### Results of control measures

How did people perform on any quality control checks or positive and negative controls? 

### Confirmatory analysis

The analyses as specified in the analysis plan.  

*Three-panel graph with original, 1st replication, and your replication is ideal here*

### Exploratory analyses

Any follow-up analyses desired (not required).  

## Discussion

## Mini meta analysis
Combining across the original paper, 1st replication, and 2nd replication, what is the aggregate effect size? 

### Summary of Replication Attempt

Open the discussion section with a paragraph summarizing the primary result from the confirmatory analysis and the assessment of whether it replicated, partially replicated, or failed to replicate the original result.  

### Commentary

Add open-ended commentary (if any) reflecting (a) insights from follow-up exploratory analysis, (b) assessment of the meaning of the replication (or not) - e.g., for a failure to replicate, are the differences between original and present study ones that definitely, plausibly, or are unlikely to have been moderators of the result, and (c) discussion of any objections or challenges raised by the current and original authors about the replication attempt.  None of these need to be long.
